<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>สมัครใช้บริการ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</head>
<body class="bg-gray-50 p-4">
  <div class="max-w-md mx-auto bg-white rounded-2xl shadow p-6">
    <!-- Status Bar -->
    <div id="status-bar" class="flex justify-between mb-6">
      <div class="flex-1 text-center" data-step="1">
        <div class="step-circle bg-green-500 text-white w-8 h-8 rounded-full mx-auto flex items-center justify-center">1</div>
        <p class="mt-2 text-sm" id="label-step-1">กรอกข้อมูล</p>
      </div>
      <div class="flex-1 text-center" data-step="2">
        <div class="step-circle bg-gray-300 text-gray-600 w-8 h-8 rounded-full mx-auto flex items-center justify-center">2</div>
        <p class="mt-2 text-sm" id="label-step-2">รอการตรวจสอบ</p>
      </div>
      <div class="flex-1 text-center" data-step="3">
        <div class="step-circle bg-gray-300 text-gray-600 w-8 h-8 rounded-full mx-auto flex items-center justify-center">3</div>
        <p class="mt-2 text-sm" id="label-step-3">เสร็จสิ้น</p>
      </div>
    </div>

    <!-- Content Area -->
    <div id="content-area">
      <!-- Fill Info -->
      <div id="step-1-content" class="space-y-4">
        <button id="btn-line-login" class="w-full py-2 bg-green-500 text-white rounded-lg">ล็อกอินด้วยไลน์</button>
        <div class="text-center">
          <img src="https://i.postimg.cc/Dz7L0r5c/logo.png" alt="จ่ายเงิน QR Code" class="mx-auto w-40" />
        </div>
        <button id="btn-confirm" class="w-full py-2 bg-green-500 text-white rounded-lg hidden">ยืนยันลงทะเบียน</button>
      </div>

      <!-- Waiting Verification -->
      <div id="step-2-content" class="hidden text-center space-y-4">
        <img src="https://i.postimg.cc/Dz7L0r5c/logo.png" alt="รอการตรวจสอบ" class="mx-auto w-48" />
        <p>อยู่ระหว่างการตรวจสอบโดยผู้ดูแล<br/>กระบวนการนี้จะเสร็จสิ้นภายใน 24 ชั่วโมง</p>
      </div>

      <!-- Completed -->
      <div id="step-3-content" class="hidden text-center space-y-4">
        <p class="text-green-600 font-semibold">ลงทะเบียนสำเร็จ!</p>
        <button id="btn-reapply" class="w-full py-2 bg-blue-600 text-white rounded-lg">ลงทะเบียนอีกครั้ง</button>
      </div>
    </div>
  </div>

  <script>
    const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxQyMf_zMNuZoa_JLqa2S5LJYgxd1HwDfnMw-3_FtMH-mN2Db72O4xfqpU17zg2mebPkw/exec';
    let userData = JSON.parse(localStorage.getItem('user')) || {};
    let lineUserId = null;

    // On load, check existing request status
    window.addEventListener('DOMContentLoaded', () => {
      if (!userData.lineId) {
        renderStep(1);
        return;
      }
      checkRequestStatus();
    });

    // LINE Login
    document.getElementById('btn-line-login').addEventListener('click', async () => {
      await liff.init({ liffId: '2007333047-XVaQjnmO' });
      if (!liff.isLoggedIn()) await liff.login();
      const profile = await liff.getProfile();
      lineUserId = profile.userId;
      userData.lineId = lineUserId;
      localStorage.setItem('user', JSON.stringify(userData));
      document.getElementById('btn-line-login').classList.replace('bg-green-500', 'bg-blue-600');
      document.getElementById('btn-line-login').textContent = 'สำเร็จ';
      document.getElementById('btn-confirm').classList.remove('hidden');
    });

    // Confirm Registration -> send to GAS
    document.getElementById('btn-confirm').addEventListener('click', async () => {
      const payload = new URLSearchParams({
        action: 'request',
        name: userData.firstName,
        surename: userData.lastName,
        number: userData.no,
        studentId: userData.studentId,
        lineId: userData.lineId,
        timestamp: new Date().toISOString(),
      });
      await fetch(GAS_ENDPOINT + '?' + payload.toString());
      renderStep(2, true);
    });

    // Reapply
    document.getElementById('btn-reapply').addEventListener('click', () => {
      // Clear previous status, optionally remove request record
      renderStep(1);
    });

    // Fetch request status from GAS
    async function checkRequestStatus() {
      const res = await fetch(`${GAS_ENDPOINT}?action=status&lineId=${userData.lineId}`);
      const data = await res.json();
      if (data.status === 'pending') renderStep(2);
      else if (data.status === 'approved') renderStep(3);
      else renderStep(1);
    }

    function renderStep(step, animate = false) {
      // Status circles
      document.querySelectorAll('#status-bar [data-step]').forEach(el => {
        const idx = +el.dataset.step;
        const circle = el.querySelector('.step-circle');
        if (idx < step) {
          circle.className = 'step-circle bg-blue-600 text-white w-8 h-8 rounded-full mx-auto flex items-center justify-center';
        } else if (idx === step) {
          circle.className = 'step-circle bg-green-500 text-white w-8 h-8 rounded-full mx-auto flex items-center justify-center';
        } else {
          circle.className = 'step-circle bg-gray-300 text-gray-600 w-8 h-8 rounded-full mx-auto flex items-center justify-center';
        }
      });
      // Show content
      [1,2,3].forEach(n => {
        document.getElementById(`step-${n}-content`).classList.toggle('hidden', n !== step);
      });
      // Optional animation
      if (animate) {
        const el = document.querySelector(`#label-step-${step}`);
        el.classList.add('transition-transform', 'transform', 'scale-110');
        setTimeout(() => el.classList.remove('scale-110'), 600);
      }
    }
  </script>
</body>
</html>
